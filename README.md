# Genconfig

This package is used during generation of the lantern global configuration.
Currently this is run from cloudmasters and managed by this salt module:
https://github.com/getlantern/lantern_aws/blob/main/salt/update_masquerades

A production binary suitable for cloudmasters can be created by running `make dist`.
The resulting binary `dist-bin/genconfig` can be used to update the corresponding
binary found in the update_masquerades salt module.

The live global.yaml is updated periodically, the current configuration can be fetched with:
`curl https://globalconfig.flashlightproxy.com/global.yaml.gz`

The embeddedGlobal.go found in flashlight is generated by downloading that file.

## Process for Updating cloud.yaml.tmpl
The generated global config is generated by filling in the `cloud.yaml.tmpl`. This template will occasionally change for one of two reasons:

1. Change the content of `cloud.yaml.tmpl` to change production configuration, for example to change enabled features by geography.
2. Change the structure of `cloud.yaml.tmpl` when the structure of the global config in flashlight changes (e.g. when we add a new section to the config like Replica configuration)

### Changing the Contents of cloud.yaml.tmpl

1. Change the values in the file [cloud.yaml.tmpl](cloud.yaml.tmpl) **without changing its structure**
2. Run the unit tests with `go test`. If the unit tests break, that means some of the tests may have relied on specific contents in the template. Update the unit tests as necessary or fix `cloud.yaml.tmpl` if you actually introduced an error
3. Once unit tests pass, build the production binary and deploy to lantern_aws

### Changing the Structure of cloud.yaml.tmpl
In this case, flashlight has changed in a way that supports new structural elements in the global config, like a new section.

It is important that cloud.yaml.tmpl parse correctly and match flashlight's expectations, and it's also important that new cloud.yaml.tmpl versions remain backwards compatible with older Lantern (flashlight) versions. To that end, this repo contains [unit tests](genconfig.go) that run against cloud.yaml.tmpl and verify that it parses correctly and contains reasonable values.

The unit tests pull in the `config` package from flashlight and parse `cloud.yaml.tmpl` into `config.Global`. In order for tests to remain relevant as flashlight evolves, the test imports specifically versioned flashlights, like `config_20220120 "github.com/getlantern/flashlight/20220120/config"`.

When making a structural change, follow this process:

1. Manually update [go.mod](go.mod) to version the current flashlight dependency, for example change `github.com/getlantern/flashlight v0.0.0-20220120195645-6263b0296ba2` to `github.com/getlantern/flashlight/20220120 v0.0.0-20220120195645-6263b0296ba2` in the `require` section and then add a corresponding replace line like `replace github.com/getlantern/flashlight/20220120 => github.com/getlantern/flashlight 20220120195645-6263b0296ba2`
2. Run `go get github.com/getlantern/flashlight@devel` to update the main flashlight dependency to the latest version
3. Add unit tests that test against `github.com/getlantern/flashlight/20220120/config` to test the new structural elements
4. Update [cloud.yaml.tmpl](cloud.yaml.tmpl) as necessary
5. Run the unit tests to make sure that the older unit tests still pass against the latest `cloud.yaml.tmpl`
6. Once unit tests pass, build the production binary and deploy to lantern_aws
